<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Ad Bricks Creative Sandbox</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    min-height: 100%;
    width: 100vw;
    box-sizing: border-box;
    font-family: sans-serif;
    background: #e0e0e0;
    transition: background 0.3s;
    -webkit-tap-highlight-color: transparent;
    touch-action: none;
  }
  body {
    min-height: 100vh;
    padding-top: 68px;
    box-sizing: border-box;
    overflow: hidden;
    /* prevent double scrollbars */
  }
  #topAdContainer {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    min-height: 55px;
    height: 9vh;
    max-height: 90px;
    background: #fff;
    z-index: 3001;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 3px 14px #0002;
    padding: 0;
  }
  #adInner {
    width: min(96vw, 336px);
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
  }
  #colorPickerWrapper {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.35);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    min-width: 100vw;
    min-height: 100vh;
  }
  #colorPickerBox {
    background: #fff;
    padding: 2em 5vw 2em 5vw;
    border-radius: 12px;
    box-shadow: 0 0 24px 2px #8884;
    text-align: center;
    min-width: 220px;
    width: 90vw;
    max-width: 320px;
  }
  #startBtn {
    margin-top: 1.5em;
    padding: 0.7em 1.5em;
    font-size: 1.1em;
    border-radius: 0.5em;
    border: none;
    background: #1976d2;
    color: #fff;
    cursor: pointer;
    width: 80%;
    max-width: 200px;
  }
  #startBtn:active { background: #145ba1; }
  label[for="bgColor"] {
    font-size: 1.1em;
    margin-bottom: 1em;
    display: block;
  }
  #toolbar {
    position: fixed;
    top: 72px;
    left: 50%;
    transform: translateX(-50%);
    background: #fffefacc;
    padding: 7px 3vw 7px 3vw;
    border-radius: 10px;
    display: flex;
    align-items: center;
    gap: 7px;
    z-index: 1001;
    box-shadow: 0 1px 10px #0001;
    width: max-content;
    min-width: 200px;
    max-width: 98vw;
    flex-wrap: wrap;
    font-size: min(4vw, 17px);
  }
  #toolbar label { font-size: inherit; }
  #toolbar select, #toolbar input[type='color'], #toolbar input[type='range'] {
    margin-right: 6px;
    font-size: inherit;
  }
  #spawnBtn {
    padding: 7px 15px;
    font-size: inherit;
    border-radius: .5em;
    border: none;
    background: #1976d2;
    color: #fff;
    cursor: pointer;
  }
  #gravityRange { width: 70px; min-width: 50px;}
  #gravityValue { min-width: 20px; display: inline-block; }
  .shape {
    position: absolute;
    border: 2px solid #333;
    background: #fff;
    overflow: hidden;
    text-align: center;
    font-weight: bold;
    color: #333;
    user-select: none;
    will-change: transform;
    z-index: 10;
    pointer-events: auto;
    touch-action: none;
  }
  .brick { width: 18vw; min-width: 90px; max-width: 220px; height: 6vw; min-height: 35px; max-height: 70px; line-height: normal; }
  .square { width: 9vw; min-width: 46px; max-width: 90px; height: 9vw; min-height: 46px; max-height: 90px; line-height: normal; }
  .circle { width: 9vw; min-width: 46px; max-width: 90px; height: 9vw; min-height: 46px; max-height: 90px; border-radius: 50%; line-height: normal;}
  .triangle {
    width: 0; height: 0;
    border-left: 5vw solid transparent;
    border-right: 5vw solid transparent;
    border-bottom: 9vw solid #fff;
    min-width: 25px; max-width: 48px;
    min-height: 46px; max-height: 90px;
    background: none;
    border-radius: 0;
    border-top: 0;
    text-indent: -9999px;
  }
  #shapeColorPickerPopup {
    position: fixed;
    z-index: 3000;
    display: none;
    background: #fff;
    padding: 16px 24px;
    border-radius: 12px;
    box-shadow: 0 0 24px 2px #8884;
    left: 50%;
    top: 50%;
    transform: translate(-50%,-50%);
    text-align: center;
    max-width: 90vw;
    min-width: 180px;
  }
  #shapeColorPickerPopup input[type='color'] {
    width: 60px;
    height: 40px;
    border: none;
    background: transparent;
    margin: 0 10px;
  }
  #shapeColorPickerPopup button {
    margin-top: 1em;
    padding: 0.5em 1.3em;
    font-size: 1em;
    border-radius: 0.4em;
    border: none;
    background: #1976d2;
    color: #fff;
    cursor: pointer;
  }
  canvas {
    pointer-events: auto !important;
    z-index: 1;
    position: fixed;
    left: 0;
    top: 0;
    width: 100vw !important;
    height: 100vh !important;
    touch-action: none;
  }
  @media (max-width: 650px) {
    #toolbar {
      flex-direction: column;
      padding: 8px 2vw;
      left: 50% !important;
      transform: translateX(-50%);
      width: 96vw;
      top: 69px;
    }
    #topAdContainer {
      height: 58px;
      min-height: 48px;
    }
  }
  @media (max-width: 440px) {
    #toolbar {
      font-size: 13px;
    }
    #startBtn {font-size: 1em;}
  }
</style>
</head>
<body>

<div id="topAdContainer">
  <div id="adInner"></div>
</div>

<div id="colorPickerWrapper">
  <div id="colorPickerBox">
    <label for="bgColor">Choose your background color:</label>
    <input type="color" id="bgColor" value="#e0e0e0">
    <br>
    <button id="startBtn">Start</button>
  </div>
</div>

<div id="toolbar" style="display:none">
  <label for="shapeType">Shape:</label>
  <select id="shapeType">
    <option value="brick">Brick</option>
    <option value="square">Square</option>
    <option value="circle">Circle</option>
    <option value="triangle">Triangle</option>
  </select>
  <input type="color" id="shapeColor" title="Shape Color" value="#ffffff">
  <label for="gravityRange">Gravity:</label>
  <input type="range" min="0" max="2" step="0.01" value="1" id="gravityRange" title="Gravity">
  <span id="gravityValue">1</span>
  <button id="spawnBtn">Spawn</button>
</div>

<!-- Shape color picker popup -->
<div id="shapeColorPickerPopup">
  <div>
    <label for="chooseShapeColor">Change shape color:</label>
    <input type="color" id="chooseShapeColor" value="#ffffff">
  </div>
  <button id="applyShapeColorBtn">Apply</button>
</div>

<script>
const { Engine, Render, Runner, Bodies, World, Events, Mouse, MouseConstraint, Composite, Vertices, Body } = Matter;

// --- Top Ad logic ---
function loadAd() {
  const adInner = document.getElementById('adInner');
  adInner.innerHTML = "";
  const adScript = document.createElement('script');
  adScript.async = true;
  adScript.setAttribute('data-cfasync', 'false');
  adScript.src = "//pl27595750.revenuecpmgate.com/29cc3422072ad8357e225b70e4a38e1a/invoke.js";
  adInner.appendChild(adScript);
}
loadAd();
setInterval(loadAd, 5000);

// --- Color picker logic ---
const colorPickerWrapper = document.getElementById('colorPickerWrapper');
const colorPicker = document.getElementById('bgColor');
const startBtn = document.getElementById('startBtn');
const toolbar = document.getElementById('toolbar');
const spawnBtn = document.getElementById('spawnBtn');
const gravityRange = document.getElementById('gravityRange');
const gravityValue = document.getElementById('gravityValue');
const shapeType = document.getElementById('shapeType');
const shapeColor = document.getElementById('shapeColor');

const shapeColorPickerPopup = document.getElementById('shapeColorPickerPopup');
const chooseShapeColor = document.getElementById('chooseShapeColor');
const applyShapeColorBtn = document.getElementById('applyShapeColorBtn');

function setBackground(color) {
  document.body.style.background = color;
}
colorPicker.addEventListener('input', (e) => setBackground(e.target.value));

startBtn.addEventListener('click', () => {
  setBackground(colorPicker.value);
  colorPickerWrapper.style.display = 'none';
  toolbar.style.display = '';
  startPhysics();
});

// Prevent double-tap zoom on mobile
document.addEventListener('touchstart', function preventZoom(e) {
  if (e.touches.length > 1) e.preventDefault();
}, { passive: false });
let lastTouchEnd = 0;
document.addEventListener('touchend', function preventDoubleTapZoom(e) {
  const now = new Date().getTime();
  if (now - lastTouchEnd <= 300) e.preventDefault();
  lastTouchEnd = now;
}, false);

// --- Matter.js and Shape logic ---
let engine, render, runner, world, mouse, mouseConstraint, boundaries = [], shapes = [];
let shapeElsToIndex = new Map();

function getShapeSizes(type) {
  // All in px, responsive via vw
  const vw = Math.max(window.innerWidth, 300) / 100;
  switch(type) {
    case 'brick': return { w: Math.max(90, Math.min(220, 18*vw)), h: Math.max(35, Math.min(70, 6*vw)) };
    case 'square': return { w: Math.max(46, Math.min(90, 9*vw)), h: Math.max(46, Math.min(90, 9*vw)) };
    case 'circle': return { w: Math.max(46, Math.min(90, 9*vw)), h: Math.max(46, Math.min(90, 9*vw)) };
    case 'triangle': return { w: Math.max(25, Math.min(48, 5*vw*2)), h: Math.max(46, Math.min(90, 9*vw)) };
  }
  return { w: 80, h: 40 };
}

function createBoundaries() {
  boundaries.forEach(b => Composite.remove(world, b));
  boundaries = [];
  const thickness = 100;
  const offset = 0;
  boundaries.push(Bodies.rectangle(-thickness/2 + offset, window.innerHeight/2, thickness, window.innerHeight, { isStatic: true }));
  boundaries.push(Bodies.rectangle(window.innerWidth + thickness/2 - offset, window.innerHeight/2, thickness, window.innerHeight, { isStatic: true }));
  boundaries.push(Bodies.rectangle(window.innerWidth/2, -thickness/2 + offset, window.innerWidth, thickness, { isStatic: true }));
  boundaries.push(Bodies.rectangle(window.innerWidth/2, window.innerHeight-10, window.innerWidth, 20, { isStatic: true }));
  World.add(world, boundaries);
}

// Ensure spawn does not overlap ad or toolbar
function getSafeSpawnY() {
  // 0 = ad, toolbar is 72px down, toolbar height ~40px
  // Add a little more margin for mobile
  let minY = Math.max(110, document.getElementById('toolbar').getBoundingClientRect().bottom + 15);
  let maxY = window.innerHeight - 110;
  return Math.min(Math.max(minY, 60), maxY);
}

function spawnShape(type, color) {
  let body, el, w, h;
  const {w: sw, h: sh} = getShapeSizes(type);
  const x = Math.random() * (window.innerWidth - sw - 8) + sw/2 + 4;
  const y = getSafeSpawnY();

  if(type==='brick') {
    w = sw; h = sh;
    body = Bodies.rectangle(x, y, w, h, { restitution: 0.3, friction: 0.5, render: { fillStyle: color } });
    el = document.createElement('div');
    el.className = 'shape brick';
    el.style.background = color;
    el.innerHTML = "";
    el.style.width = w+'px';
    el.style.height = h+'px';
  } else if(type==='square') {
    w = h = sw;
    body = Bodies.rectangle(x, y, w, h, { restitution: 0.3, friction: 0.5, render: { fillStyle: color } });
    el = document.createElement('div');
    el.className = 'shape square';
    el.style.background = color;
    el.innerText = '';
    el.style.width = w+'px';
    el.style.height = h+'px';
  } else if(type==='circle') {
    w = h = sw;
    body = Bodies.circle(x, y, w/2, { restitution: 0.3, friction: 0.5, render: { fillStyle: color } });
    el = document.createElement('div');
    el.className = 'shape circle';
    el.style.background = color;
    el.innerText = '';
    el.style.width = w+'px';
    el.style.height = h+'px';
  } else if(type==='triangle') {
    w = sw; h = sh;
    // Equilateral triangle vertices
    const verts = Vertices.fromPath(`0 ${h} ${w/2} 0 ${w} ${h}`);
    body = Bodies.fromVertices(x, y, [verts], { restitution: 0.3, friction: 0.5, render: { fillStyle: color } }, true);
    el = document.createElement('div');
    el.className = 'shape triangle';
    el.style.borderLeft = (w/2)+"px solid transparent";
    el.style.borderRight = (w/2)+"px solid transparent";
    el.style.borderBottom = h+"px solid "+color;
    el.innerText = '';
    el.style.width = "0";
    el.style.height = "0";
    // for easier hit target for dragging
    el.style.pointerEvents = "auto";
  }

  document.body.appendChild(el);
  World.add(world, body);
  let shapeObj = { body, el, type, color, w, h };
  shapes.push(shapeObj);
  shapeElsToIndex.set(el, shapes.length - 1);

  // attach long press handler for color picker
  setupLongPressColorPicker(el, shapeObj);
}

function updateShapeColor(shapeObj, newColor) {
  shapeObj.color = newColor;
  if (shapeObj.type === "triangle") {
    // update triangle color
    shapeObj.el.style.borderBottomColor = newColor;
  } else {
    shapeObj.el.style.background = newColor;
  }
}

function startPhysics() {
  engine = Engine.create();
  engine.gravity.y = parseFloat(gravityRange.value);
  world = engine.world;

  render = Render.create({
      element: document.body,
      engine: engine,
      options: { width: window.innerWidth, height: window.innerHeight, wireframes: false, background: 'transparent' }
  });

  Render.run(render);
  runner = Runner.create();
  Runner.run(runner, engine);

  // Add mouse constraint for dragging
  mouse = Mouse.create(render.canvas);
  mouse.pixelRatio = window.devicePixelRatio || 1;
  mouseConstraint = MouseConstraint.create(engine, {
      mouse: mouse,
      constraint: {
          stiffness: 0.2,
          render: { visible: false }
      }
  });
  World.add(world, mouseConstraint);
  render.mouse = mouse;

  createBoundaries();
  shapes = [];
  shapeElsToIndex = new Map();
  spawnShape('brick', shapeColor.value);

  spawnBtn.addEventListener('click', () => {
    spawnShape(shapeType.value, shapeColor.value);
  });

  // Forward pointer events from shapes to Matter.js canvas for dragging
  function forwardPointerEvent(type) {
    return function(e) {
      if (e.target.classList.contains('shape')) {
        const canvas = render.canvas;
        const evt = new MouseEvent(type, {
          clientX: e.clientX,
          clientY: e.clientY,
          screenX: e.screenX,
          screenY: e.screenY,
          bubbles: true
        });
        canvas.dispatchEvent(evt);
      }
    }
  }
  document.body.addEventListener('pointerdown', forwardPointerEvent('mousedown'));
  document.body.addEventListener('pointermove', forwardPointerEvent('mousemove'));
  document.body.addEventListener('pointerup', forwardPointerEvent('mouseup'));

  Events.on(engine, 'afterUpdate', () => {
    shapes.forEach((s, idx) => {
      let b = s.body, el = s.el, t = s.type;
      if (t === 'brick' || t === 'square') {
        el.style.left = (b.position.x - s.w/2) + 'px';
        el.style.top = (b.body.position.y - s.h/2) + 'px';
        el.style.transform = `rotate(${b.body.angle}rad)`;
        el.style.background = s.color;
      } else if (t === 'circle') {
        el.style.left = (b.body.position.x - s.w/2) + 'px';
        el.style.top = (b.body.position.y - s.h/2) + 'px';
        el.style.transform = `rotate(${b.body.angle}rad)`;
        el.style.background = s.color;
      } else if (t === 'triangle') {
        el.style.left = (b.body.position.x - s.w/2) + 'px';
        el.style.top = (b.body.position.y - s.h/2) + 'px';
        el.style.transform = `rotate(${b.body.angle}rad)`;
        el.style.borderBottomColor = s.color;
      }
    });
  });

  window.addEventListener('resize', () => {
    render.options.width = window.innerWidth;
    render.options.height = window.innerHeight;
    render.canvas.width = window.innerWidth;
    render.canvas.height = window.innerHeight;
    createBoundaries();
  });

  // Gravity range logic
  gravityRange.addEventListener('input', () => {
    engine.gravity.y = parseFloat(gravityRange.value);
    gravityValue.innerText = gravityRange.value;
  });
  gravityValue.innerText = gravityRange.value;

  shapeColor.addEventListener('input', () => {});
}

// --- Long Press Color Picker ---
function setupLongPressColorPicker(el, shapeObj) {
  let longPressTimer = null;
  let pointerDown = false;

  function showColorPickerForShape() {
    chooseShapeColor.value = shapeObj.color;
    shapeColorPickerPopup.style.display = 'block';
    shapeColorPickerPopup.dataset.shapeIndex = shapes.indexOf(shapeObj);
  }

  el.addEventListener('pointerdown', function(e) {
    pointerDown = true;
    longPressTimer = setTimeout(() => {
      showColorPickerForShape();
    }, 1200);
  });

  el.addEventListener('pointerup', function(e) {
    pointerDown = false;
    clearTimeout(longPressTimer);
  });
  el.addEventListener('pointerleave', function(e) {
    pointerDown = false;
    clearTimeout(longPressTimer);
  });
  el.addEventListener('pointercancel', function(e) {
    pointerDown = false;
    clearTimeout(longPressTimer);
  });
}

// Handle color picker popup for shape
applyShapeColorBtn.addEventListener('click', function() {
  const idx = parseInt(shapeColorPickerPopup.dataset.shapeIndex, 10);
  if (!isNaN(idx) && shapes[idx]) {
    updateShapeColor(shapes[idx], chooseShapeColor.value);
  }
  shapeColorPickerPopup.style.display = 'none';
});

chooseShapeColor.addEventListener('input', function() {});

document.addEventListener('click', function(e) {
  if (
    shapeColorPickerPopup.style.display === 'block' &&
    !shapeColorPickerPopup.contains(e.target)
  ) {
    shapeColorPickerPopup.style.display = 'none';
  }
});

// Set initial color on load
setBackground(colorPicker.value);
</script>
</body>
</html>